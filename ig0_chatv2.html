<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ight2 | Liquid Glass</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        /* --- 1. CONFIG & VARIABLES --- */
        :root {
            /* Colors */
            --bg: #000000;
            --glass: rgba(20, 20, 20, 0.65);
            --glass-border: 1px solid rgba(255, 255, 255, 0.08);
            --glass-highlight: rgba(255, 255, 255, 0.15);
            
            --accent: #ff0055;
            --accent-grad: linear-gradient(135deg, #ff0055, #ff00cc);
            --text-main: #ffffff;
            --text-dim: #888888;
            
            /* Sizing */
            --radius: 18px;
            --sidebar-w: 260px;
            
            /* Animations */
            --ease: cubic-bezier(0.23, 1, 0.32, 1);
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--accent); }

        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; background: var(--bg);
            color: var(--text-main); font-family: 'Outfit', sans-serif;
            height: 100vh; overflow: hidden; display: flex;
            font-size: 15px;
        }

        /* --- 2. LIQUID BACKGROUND --- */
        .liquid-layer {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1; overflow: hidden; pointer-events: none;
            transition: opacity 0.5s ease;
        }
        .liquid-layer.hidden { opacity: 0; }

        .blob {
            position: absolute; border-radius: 50%;
            filter: blur(80px); opacity: 0.6;
            animation: float 10s infinite alternate ease-in-out;
        }
        .b1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: #ff00cc; animation-duration: 25s; }
        .b2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #00ccff; animation-duration: 30s; }
        .b3 { top: 40%; left: 40%; width: 30vw; height: 30vw; background: #6600ff; animation-duration: 20s; }

        @keyframes float { 0% { transform: translate(0,0); } 100% { transform: translate(30px, -30px); } }

        /* --- 3. LAYOUT --- */
        .app {
            display: flex; width: 100%; height: 100%;
            padding: 15px; gap: 15px; max-width: 1800px; margin: 0 auto;
        }

        /* Glass Panels */
        .panel {
            background: var(--glass);
            backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
            border: var(--glass-border);
            border-radius: var(--radius);
            display: flex; flex-direction: column;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            transition: 0.3s var(--ease);
        }

        /* SIDEBAR */
        .sidebar { width: var(--sidebar-w); flex-shrink: 0; padding: 20px; }
        .logo { font-size: 24px; font-weight: 800; letter-spacing: -1px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .logo span { background: var(--accent-grad); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .nav-title { font-size: 11px; text-transform: uppercase; color: var(--text-dim); margin-bottom: 10px; font-weight: 700; letter-spacing: 1px; }
        .nav-list { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; }
        
        .nav-item {
            padding: 10px 12px; border-radius: 10px; cursor: pointer;
            transition: 0.2s; color: #ccc; display: flex; align-items: center; gap: 8px;
        }
        .nav-item:hover { background: var(--glass-highlight); color: white; }
        .nav-item.active { background: var(--accent-grad); color: white; box-shadow: 0 4px 15px rgba(255,0,85,0.4); }

        .my-profile {
            margin-top: 15px; padding: 12px; background: rgba(0,0,0,0.3);
            border-radius: 12px; display: flex; align-items: center; gap: 10px; cursor: pointer;
            border: 1px solid transparent; transition: 0.2s;
        }
        .my-profile:hover { border-color: var(--accent); background: rgba(0,0,0,0.5); }
        .avatar { width: 36px; height: 36px; border-radius: 8px; background: #222; object-fit: cover; border: 1px solid rgba(255,255,255,0.1); }

        /* CHAT AREA */
        .chat-main { flex-grow: 1; min-width: 0; position: relative; }
        
        .chat-header {
            height: 60px; border-bottom: var(--glass-border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 20px; font-weight: 700; font-size: 18px;
        }
        
        .messages {
            flex-grow: 1; overflow-y: scroll; padding: 20px;
            display: flex; flex-direction: column; gap: 8px;
        }

        /* Message Bubbles */
        .msg { display: flex; align-items: flex-end; gap: 10px; opacity: 0; animation: fadeUp 0.3s forwards; }
        .msg.me { flex-direction: row-reverse; }
        
        @keyframes fadeUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .bubble {
            max-width: 70%; padding: 10px 16px; border-radius: 18px;
            font-size: 15px; line-height: 1.5; word-wrap: break-word;
            position: relative;
        }
        .msg.other .bubble { background: rgba(255,255,255,0.07); border-bottom-left-radius: 4px; }
        .msg.me .bubble { background: var(--accent-grad); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(255,0,85,0.2); }
        
        .msg-info { font-size: 11px; color: var(--text-dim); margin-bottom: 2px; margin-left: 2px; }
        .msg.me .msg-info { text-align: right; margin-right: 2px; }

        /* Input Area */
        .input-area { padding: 20px; border-top: var(--glass-border); }
        .input-bar {
            background: rgba(0,0,0,0.3); border-radius: 50px;
            display: flex; align-items: center; padding: 5px 5px 5px 20px;
            border: 1px solid rgba(255,255,255,0.1); transition: 0.3s;
        }
        .input-bar:focus-within { border-color: var(--accent); box-shadow: 0 0 15px rgba(255,0,85,0.2); }
        
        input { flex-grow: 1; background: transparent; border: none; color: white; padding: 10px 0; font-size: 16px; font-family: inherit; }
        
        .send-btn {
            width: 42px; height: 42px; background: var(--accent); border-radius: 50%;
            border: none; color: white; cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: 0.2s;
        }
        .send-btn:hover { transform: scale(1.1); background: white; color: var(--accent); }

        /* RIGHT PANEL */
        .right-panel { width: 220px; flex-shrink: 0; padding: 20px; }
        .online-user {
            display: flex; align-items: center; gap: 10px; padding: 8px;
            border-radius: 8px; cursor: pointer; transition: 0.2s; color: #ddd;
        }
        .online-user:hover { background: var(--glass-highlight); color: white; }
        .dot { width: 8px; height: 8px; background: #00ff88; border-radius: 50%; box-shadow: 0 0 8px #00ff88; }

        /* --- 4. CUSTOM MODALS (No Alerts) --- */
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); backdrop-filter: blur(10px);
            z-index: 100; opacity: 0; pointer-events: none; transition: 0.3s;
            display: flex; align-items: center; justify-content: center;
        }
        .overlay.active { opacity: 1; pointer-events: all; }

        .modal {
            background: #111; border: 1px solid #333; padding: 30px;
            border-radius: 24px; width: 400px; max-width: 90%;
            transform: scale(0.9); transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .overlay.active .modal { transform: scale(1); }

        .modal h2 { margin: 0 0 20px 0; font-weight: 800; font-size: 24px; color: white; }
        .field-label { display: block; color: #888; font-size: 12px; margin-bottom: 8px; text-transform: uppercase; font-weight: 700; }
        .modal-input {
            width: 100%; background: #222; border: 1px solid #444; color: white;
            padding: 12px; border-radius: 10px; margin-bottom: 20px;
            font-size: 16px; font-family: inherit; transition: 0.2s;
        }
        .modal-input:focus { border-color: var(--accent); }

        .modal-btn {
            width: 100%; padding: 14px; background: var(--accent); border: none;
            color: white; border-radius: 12px; font-weight: 700; font-size: 16px; cursor: pointer;
            transition: 0.2s; margin-top: 10px;
        }
        .modal-btn:hover { opacity: 0.9; transform: translateY(-2px); }
        .modal-close { margin-top: 15px; text-align: center; color: #666; font-size: 13px; cursor: pointer; text-decoration: underline; }

        /* Theme Grid */
        .theme-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 20px; }
        .theme-opt { height: 50px; border-radius: 12px; cursor: pointer; position: relative; overflow: hidden; border: 2px solid transparent; transition: 0.2s; }
        .theme-opt.selected { border-color: white; transform: scale(1.05); }

        /* SVG Icons */
        .icon { width: 20px; height: 20px; fill: currentColor; }
        .icon-btn { padding: 8px; border-radius: 50%; cursor: pointer; transition: 0.2s; display: flex; }
        .icon-btn:hover { background: rgba(255,255,255,0.1); }

        /* PFP Canvas */
        .canvas-wrap { display: flex; justify-content: center; margin: 20px 0; }
        canvas { border: 2px solid #333; border-radius: 8px; cursor: crosshair; image-rendering: pixelated; }
        .colors { display: flex; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .p-col { width: 24px; height: 24px; border-radius: 6px; cursor: pointer; border: 1px solid rgba(255,255,255,0.1); transition: 0.2s; }
        .p-col.active { transform: scale(1.2); border: 2px solid white; box-shadow: 0 0 10px currentColor; }

        /* Mobile */
        @media (max-width: 850px) {
            .sidebar, .right-panel { display: none; } /* Simplified for this demo */
            .app { padding: 0; }
            .panel { border-radius: 0; border: none; }
        }
    </style>
</head>
<body>

    <div class="liquid-layer" id="liquid-bg">
        <div class="blob b1"></div>
        <div class="blob b2"></div>
        <div class="blob b3"></div>
    </div>

    <div class="app">
        <div class="panel sidebar">
            <div class="logo">
                <span>ight2</span>
                <div class="icon-btn" onclick="openModal('settings-modal')">
                    <svg class="icon" viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 0 0 8 4 4 0 0 0 0-8zm0 6a2 2 0 1 1 0-4 2 2 0 0 1 0 4zm0-12a10 10 0 1 1 0 20 10 10 0 0 1 0-20zm0 18a8 8 0 1 0 0-16 8 8 0 0 0 0 16z"/></svg>
                </div>
            </div>

            <div class="nav-title">Rooms</div>
            <div class="nav-list">
                <div class="nav-item active" onclick="changeRoom('public', '#public')">
                    <span>#</span> public
                </div>
                <div class="nav-title" style="margin-top:20px;">Direct Messages</div>
                <div id="dm-list" style="display:flex; flex-direction:column; gap:4px"></div>
            </div>

            <div class="my-profile" onclick="openModal('pfp-modal')">
                <img id="current-pfp" class="avatar" src="">
                <div style="overflow:hidden;">
                    <div id="current-username" style="font-weight:700; font-size:14px; white-space:nowrap;">Loading...</div>
                    <div style="font-size:11px; color:var(--text-dim)">Edit Profile</div>
                </div>
            </div>
        </div>

        <div class="panel chat-main">
            <div class="chat-header">
                <span id="header-title">#public</span>
                <span id="header-online" style="font-size:12px; color:var(--accent)">0 online</span>
            </div>

            <div class="messages" id="msgs"></div>

            <div class="input-area">
                <div class="input-bar">
                    <input type="text" id="msg-input" placeholder="Type a message..." autocomplete="off">
                    <button class="send-btn" id="send-btn">
                        <svg class="icon" style="transform:translateX(2px)" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
                    </button>
                </div>
            </div>
        </div>

        <div class="panel right-panel">
            <div class="nav-title">Online Now</div>
            <div id="online-list" style="margin-top:10px; display:flex; flex-direction:column; gap:2px"></div>
        </div>
    </div>

    <div class="overlay" id="settings-modal">
        <div class="modal">
            <h2>Settings</h2>
            
            <div class="field-label">Display Name</div>
            <input type="text" class="modal-input" id="set-username" placeholder="Enter username">

            <div class="field-label">Liquid Background</div>
            <div class="nav-item" onclick="toggleLiquid()" style="background:#222; margin-bottom:20px; justify-content:space-between;">
                <span>Show Liquid Animations</span>
                <div id="liquid-toggle-status" style="color:var(--accent); font-weight:bold;">ON</div>
            </div>

            <div class="field-label">Color Theme</div>
            <div class="theme-grid" id="theme-grid"></div>

            <button class="modal-btn" onclick="saveSettings()">Save Changes</button>
            <div class="modal-close" onclick="closeModals()">Cancel</div>
        </div>
    </div>

    <div class="overlay" id="pfp-modal">
        <div class="modal">
            <h2>Draw Avatar</h2>
            <div class="canvas-wrap"><canvas id="can" width="320" height="320"></canvas></div>
            <div class="colors" id="pal"></div>
            <button class="modal-btn" onclick="savePfp()">Save Avatar</button>
            <div class="modal-close" onclick="closeModals()">Cancel</div>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
    import { getAuth, signInAnonymously, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, onSnapshot, serverTimestamp, doc, setDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDE4Q6lP4EMxEnjDbM9M-RsV7P4E7Ihl_U",
        authDomain: "chatdata-99b18.firebaseapp.com",
        projectId: "chatdata-99b18",
        storageBucket: "chatdata-99b18.firebasestorage.app",
        messagingSenderId: "64431655608",
        appId: "1:64431655608:web:d056deb328eb749b41824d",
        measurementId: "G-ELQW99ZV77"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let user = null;
    let roomId = 'public';
    let unsub = null;

    // --- DOM ---
    const msgsDiv = document.getElementById('msgs');
    const input = document.getElementById('msg-input');

    // --- AUTH ---
    onAuthStateChanged(auth, (u) => {
        if(u) {
            user = u;
            if(!user.displayName) updateProfile(user, { displayName: `User${user.uid.slice(0,4)}` });
            renderSelf();
            initApp();
        } else {
            signInAnonymously(auth);
        }
    });

    function initApp() {
        loadMsgs();
        heartbeat();
        loadOnline();
    }

    // --- MESSAGING ---
    function loadMsgs() {
        if(unsub) unsub();
        msgsDiv.innerHTML = ''; 

        const q = query(collection(db, "messages"), orderBy("createdAt", "desc"), limit(60));
        
        unsub = onSnapshot(q, (snap) => {
            const data = [];
            snap.forEach(d => data.push(d.data()));
            data.reverse(); // Order old -> new

            // Smart Render: Only clear if drastic change, otherwise we should append. 
            // For simplicity in this demo, we re-render but maintain scroll position if reading history.
            
            const wasAtBottom = (msgsDiv.scrollTop + msgsDiv.clientHeight) >= (msgsDiv.scrollHeight - 100);
            
            msgsDiv.innerHTML = '';
            
            data.forEach(msg => {
                if(msg.roomId === roomId || (!msg.roomId && roomId === 'public')) {
                    appendMsg(msg);
                }
            });

            // Scroll Logic
            if(wasAtBottom) msgsDiv.scrollTop = msgsDiv.scrollHeight;
        });
    }

    async function send() {
        const txt = input.value.trim();
        if(!txt || !user) return;
        input.value = '';
        
        // Optimistic UI: scroll to bottom immediately
        msgsDiv.scrollTop = msgsDiv.scrollHeight;

        try {
            await addDoc(collection(db, "messages"), {
                text: txt, uid: user.uid, displayName: user.displayName,
                photoURL: user.photoURL, roomId: roomId, createdAt: serverTimestamp()
            });
        } catch(e) { console.error(e); }
    }

    input.addEventListener('keydown', e => { if(e.key === 'Enter') send(); });
    document.getElementById('send-btn').onclick = send;

    function appendMsg(msg) {
        const isMe = msg.uid === user.uid;
        const div = document.createElement('div');
        div.className = `msg ${isMe ? 'me' : 'other'}`;
        
        const pfp = msg.photoURL || `https://ui-avatars.com/api/?name=${msg.uid}&background=333&color=fff`;
        
        div.innerHTML = `
            ${!isMe ? `<img src="${pfp}" class="avatar" style="width:28px;height:28px">` : ''}
            <div>
                <div class="msg-info">${isMe ? '' : msg.displayName}</div>
                <div class="bubble">${esc(msg.text)}</div>
            </div>
        `;
        msgsDiv.appendChild(div);
    }

    // --- ROOMS & DMS ---
    window.changeRoom = (id, title) => {
        roomId = id;
        document.getElementById('header-title').innerText = title;
        document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
        // If clicking public
        if(id === 'public') document.querySelector('.nav-item').classList.add('active');
        loadMsgs();
    };

    window.startDm = (uid, name) => {
        const ids = [user.uid, uid].sort().join('_');
        const dmId = `dm_${ids}`;
        const list = document.getElementById('dm-list');
        
        // check duplicate
        if(!document.getElementById(`nav-${dmId}`)) {
            const el = document.createElement('div');
            el.className = 'nav-item';
            el.id = `nav-${dmId}`;
            el.innerHTML = `<span style="color:var(--accent)">@</span> ${name}`;
            el.onclick = () => {
                document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
                el.classList.add('active');
                window.changeRoom(dmId, `@ ${name}`);
            };
            list.appendChild(el);
        }
        // trigger click
        document.getElementById(`nav-${dmId}`).click();
    }

    // --- PRESENCE ---
    function heartbeat() {
        const tick = () => {
            setDoc(doc(db, "users", user.uid), {
                uid: user.uid, displayName: user.displayName, 
                photoURL: user.photoURL || null, lastSeen: serverTimestamp()
            }, { merge: true });
        };
        tick(); setInterval(tick, 60000);
    }

    function loadOnline() {
        const q = query(collection(db, "users"), orderBy("lastSeen", "desc"), limit(20));
        onSnapshot(q, (snap) => {
            const list = document.getElementById('online-list');
            list.innerHTML = '';
            let count = 0;
            snap.forEach(d => {
                const u = d.data();
                // Simple client-side timeout check (5 mins)
                const diff = (new Date() - (u.lastSeen?.toDate() || new Date())) / 1000 / 60;
                if(diff < 5 && u.uid !== user.uid) {
                    count++;
                    const el = document.createElement('div');
                    el.className = 'online-user';
                    el.innerHTML = `
                        <img src="${u.photoURL || `https://ui-avatars.com/api/?name=${u.uid}&background=333&color=fff`}" style="width:24px;height:24px;border-radius:8px">
                        <span style="flex-grow:1; font-size:13px">${esc(u.displayName)}</span>
                        <div class="dot"></div>
                    `;
                    el.onclick = () => window.startDm(u.uid, u.displayName);
                    list.appendChild(el);
                }
            });
            document.getElementById('header-online').innerText = `${count + 1} online`;
        });
    }

    // --- MODALS & SETTINGS ---
    window.openModal = (id) => {
        document.getElementById(id).classList.add('active');
        if(id === 'settings-modal') document.getElementById('set-username').value = user.displayName;
    };
    window.closeModals = () => document.querySelectorAll('.overlay').forEach(e => e.classList.remove('active'));

    window.saveSettings = async () => {
        const name = document.getElementById('set-username').value;
        if(name && name !== user.displayName) {
            await updateProfile(user, { displayName: name });
            renderSelf();
        }
        window.closeModals();
    };

    // --- LIQUID TOGGLE ---
    let liquidOn = true;
    window.toggleLiquid = () => {
        liquidOn = !liquidOn;
        const bg = document.getElementById('liquid-bg');
        const stat = document.getElementById('liquid-toggle-status');
        if(liquidOn) {
            bg.classList.remove('hidden');
            stat.innerText = "ON";
        } else {
            bg.classList.add('hidden');
            stat.innerText = "OFF";
        }
    };

    // --- THEME ENGINE ---
    const themes = [
        { c: '#ff0055', g: 'linear-gradient(135deg, #ff0055, #ff00cc)', bg: '#000000' },
        { c: '#00ccff', g: 'linear-gradient(135deg, #00ccff, #0055ff)', bg: '#000510' },
        { c: '#00ff88', g: 'linear-gradient(135deg, #00ff88, #009944)', bg: '#051005' }
    ];
    const grid = document.getElementById('theme-grid');
    themes.forEach(t => {
        const d = document.createElement('div');
        d.className = 'theme-opt';
        d.style.background = t.bg;
        d.style.borderTop = `4px solid ${t.c}`;
        d.onclick = () => {
            document.documentElement.style.setProperty('--accent', t.c);
            document.documentElement.style.setProperty('--accent-grad', t.g);
            document.documentElement.style.setProperty('--bg', t.bg);
        };
        grid.appendChild(d);
    });

    // --- PFP DRAWER (Clean Logic) ---
    const cvs = document.getElementById('can');
    const ctx = cvs.getContext('2d');
    let paint = false;
    let color = '#ff0055';
    const scale = 10; 

    // Init Palette
    const pal = ['#000', '#fff', '#ff0055', '#00ccff', '#00ff88', '#ffcc00', '#555'];
    document.getElementById('pal').innerHTML = pal.map(c => 
        `<div class="p-col" style="background:${c}" onclick="setColor('${c}', this)"></div>`
    ).join('');
    
    window.setColor = (c, el) => {
        color = c;
        document.querySelectorAll('.p-col').forEach(e => e.classList.remove('active'));
        el.classList.add('active');
    };

    function draw(x,y) {
        ctx.fillStyle = color;
        ctx.fillRect(Math.floor(x/scale)*scale, Math.floor(y/scale)*scale, scale, scale);
    }
    
    cvs.onmousedown = e => { paint = true; draw(e.offsetX, e.offsetY); };
    cvs.onmousemove = e => { if(paint) draw(e.offsetX, e.offsetY); };
    window.onmouseup = () => paint = false;

    // Open Drawer (Reset)
    window.openModal = (id) => {
        document.getElementById(id).classList.add('active');
        if(id === 'pfp-modal') {
            ctx.fillStyle = '#111'; ctx.fillRect(0,0,320,320);
        } else if (id === 'settings-modal') {
            document.getElementById('set-username').value = user.displayName;
        }
    };

    window.savePfp = async () => {
        const url = cvs.toDataURL();
        await updateProfile(user, { photoURL: url });
        renderSelf();
        window.closeModals();
    };

    function renderSelf() {
        document.getElementById('current-username').innerText = user.displayName;
        document.getElementById('current-pfp').src = user.photoURL || `https://ui-avatars.com/api/?name=${user.uid}&background=333&color=fff`;
    }

    function esc(t) { return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"); }
</script>
</body>
</html>